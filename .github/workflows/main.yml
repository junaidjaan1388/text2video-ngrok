# .github/workflows/video-server.yml
name: Video Generation Server with URL

on: 
  workflow_dispatch:
    inputs:
      server_duration:
        description: 'How long to keep server running (minutes)'
        required: false
        default: '30'

jobs:
  server:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.server_duration || 30 }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install diffusers transformers
        pip install fastapi uvicorn pyngrok
        pip install opencv-python imageio imageio-ffmpeg pillow
        
    - name: Setup ngrok
      run: |
        pip install pyngrok
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: Create simple video server
      run: |
        cat > server.py << 'EOF'
        from fastapi import FastAPI, HTTPException
        from fastapi.responses import FileResponse
        from pydantic import BaseModel
        import uvicorn
        import threading
        from pyngrok import ngrok
        import time
        import os
        
        app = FastAPI()
        
        class VideoRequest(BaseModel):
            prompt: str = "A teddy bear waving"
            steps: int = 10
            frames: int = 4
            
        @app.get("/")
        async def home():
            return {
                "message": "ðŸŽ¬ Video Generation Server", 
                "status": "running",
                "endpoints": {
                    "generate": "POST /generate",
                    "health": "GET /health"
                }
            }
        
        @app.get("/health")
        async def health():
            return {"status": "healthy"}
        
        @app.post("/generate")
        async def generate_video(request: VideoRequest):
            try:
                print(f"ðŸŽ¬ Generating video: {request.prompt}")
                
                # Import here to avoid slow startup
                from diffusers import DiffusionPipeline
                from diffusers.utils import export_to_video
                
                # Load model
                pipe = DiffusionPipeline.from_pretrained('damo-vilab/text-to-video-ms-1.7b')
                pipe = pipe.to('cpu')
                
                # Generate video
                video_frames = pipe(
                    request.prompt,
                    num_inference_steps=request.steps,
                    num_frames=request.frames,
                    height=64,
                    width=64,
                ).frames[0]
                
                # Save video
                filename = f"video_{int(time.time())}.mp4"
                os.makedirs("videos", exist_ok=True)
                video_path = f"videos/{filename}"
                export_to_video(video_frames, video_path)
                
                return {
                    "status": "success",
                    "message": "Video generated!",
                    "download_url": f"/download/{filename}",
                    "prompt": request.prompt
                }
                
            except Exception as e:
                raise HTTPException(status_code=500, detail=str(e))
        
        @app.get("/download/{filename}")
        async def download_video(filename: str):
            video_path = f"videos/{filename}"
            if os.path.exists(video_path):
                return FileResponse(video_path, filename=filename)
            raise HTTPException(status_code=404, detail="Video not found")
        
        def start_server():
            uvicorn.run(app, host="0.0.0.0", port=8000)
        
        if __name__ == "__main__":
            # Start ngrok
            public_url = ngrok.connect(8000)
            print(f"ðŸš€ PUBLIC URL: {public_url}")
            
            # Write URL to file
            with open("public_url.txt", "w") as f:
                f.write(str(public_url))
            
            # Start server
            server_thread = threading.Thread(target=start_server)
            server_thread.daemon = True
            server_thread.start()
            
            # Keep alive
            try:
                time.sleep(60 * 25)  # 25 minutes
            except:
                pass
        EOF

    - name: Start server and get public URL
      run: |
        python server.py &
        sleep 10
        
        # Get public URL
        if [ -f "public_url.txt" ]; then
            PUBLIC_URL=$(cat public_url.txt)
        else
            PUBLIC_URL=$(curl -s localhost:4040/api/tunnels | python3 -c "import sys, json; print(json.load(sys.stdin)['tunnels'][0]['public_url'])")
        fi
        
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV
        echo "ðŸŽ‰ SERVER URL: $PUBLIC_URL"
        
    - name: Display clickable link
      run: |
        echo "==================================================="
        echo "ðŸš€ VIDEO GENERATION SERVER IS READY!"
        echo "==================================================="
        echo ""
        echo "ðŸ‘‰ CLICK THIS LINK TO ACCESS YOUR SERVER:"
        echo "   $PUBLIC_URL"
        echo ""
        echo "ðŸ“‹ HOW TO USE:"
        echo "   1. Click the link above"
        echo "   2. You'll see API documentation"
        echo "   3. Test the /generate endpoint with:"
        echo "      {'prompt': 'A teddy bear waving'}"
        echo ""
        echo "â° Server will run for 25 minutes"
        echo "==================================================="
        
        # Create a direct link in workflow summary
        echo "## ðŸŽ¬ Video Generation Server" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ‘‰ [Click here to access your server]($PUBLIC_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Quick test:**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "curl -X POST '$PUBLIC_URL/generate' \\" >> $GITHUB_STEP_SUMMARY
        echo "  -H 'Content-Type: application/json' \\" >> $GITHUB_STEP_SUMMARY
        echo "  -d '{\"prompt\": \"A teddy bear waving\"}'" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Keep server alive
      run: |
        echo "ðŸ•’ Server will stay active for 25 minutes..."
        echo "ðŸ“± Access at: $PUBLIC_URL"
        sleep 1500

    - name: Cleanup
      if: always()
      run: |
        pkill -f "python server.py" || true
        pkill -f ngrok || true
        echo "âœ… Server stopped"VER:"
        echo "   $PUBLIC_URL"
        echo ""
        echo "ðŸ“‹ QUICK START:"
        echo "   1. Click the link above"
        echo "   2. You'll see the API documentation"
        echo "   3. Use the /generate endpoint to create videos"
        echo ""
        echo "ðŸ”§ ENDPOINTS:"
        echo "   â€¢ $PUBLIC_URL/          - Server info"
        echo "   â€¢ $PUBLIC_URL/health    - Health check"
        echo "   â€¢ $PUBLIC_URL/generate  - Generate videos (POST)"
        echo "   â€¢ $PUBLIC_URL/requests  - View all requests"
        echo ""
        echo "ðŸ’¡ EXAMPLE USAGE:"
        echo "   curl -X POST $PUBLIC_URL/generate \\"
        echo "     -H \"Content-Type: application/json\" \\"
        echo "     -d '{\"prompt\": \"A teddy bear waving\"}'"
        echo ""
        echo "â° Server will automatically shut down after 25 minutes"
        echo "================================================"

    - name: Keep server running
      run: |
        echo "â° Server will run for 25 minutes..."
        echo "ðŸ“± Access your server at: $PUBLIC_URL"
        echo "ðŸ”„ Check the workflow logs for any generation requests"
        sleep 1500  # 25 minutes

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        kill $SERVER_PID 2>/dev/null || true
        pkill ngrok 2>/dev/null || true
        echo "Server stopped"
