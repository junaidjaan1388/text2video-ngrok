# .github/workflows/video-server-localtunnel.yml
name: Video Server with LocalTunnel

on: [workflow_dispatch]

jobs:
  server:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python and Node.js
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Setup Node.js for localtunnel
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        # Python dependencies
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install diffusers transformers fastapi uvicorn
        pip install opencv-python imageio imageio-ffmpeg pillow
        
        # Node.js dependencies
        npm install -g localtunnel
        
    - name: Create and start server
      run: |
        # Create server script (same as above)
        cat > server.py << 'EOF'
        # ... (use the same FastAPI server code from above)
        EOF
        
        # Start server in background
        python server.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 10
        
        # Start localtunnel
        npx localtunnel --port 8000 > lt_output.txt 2>&1 &
        echo "LT_PID=$!" >> $GITHUB_ENV
        sleep 10
        
        # Get the URL from localtunnel output
        LT_URL=$(grep -o 'https://.*\.loca\.lt' lt_output.txt | head -1)
        echo "PUBLIC_URL=$LT_URL" >> $GITHUB_ENV
        echo "ğŸŒ LocalTunnel URL: $LT_URL"

    - name: Display URL
      run: |
        echo "=========================================="
        echo "ğŸš€ Server URL: $PUBLIC_URL"
        echo "=========================================="
        sleep 1500
