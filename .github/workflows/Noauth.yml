# .github/workflows/video-server-serveo.yml
name: Video Server - No Password

on: [workflow_dispatch]

jobs:
  server:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install diffusers transformers fastapi uvicorn
        pip install opencv-python imageio imageio-ffmpeg pillow
        
    - name: Create video server
      run: |
        cat > server.py << 'EOF'
        from fastapi import FastAPI, HTTPException
        from fastapi.responses import FileResponse
        from pydantic import BaseModel
        import uvicorn
        import threading
        import time
        import os
        import subprocess
        from datetime import datetime
        
        app = FastAPI()
        
        class VideoRequest(BaseModel):
            prompt: str = "A teddy bear waving"
            steps: int = 10
            frames: int = 4
        
        @app.get("/")
        async def home():
            return {"message": "ğŸ¬ Video Server - No Password!"}
        
        @app.get("/health")
        async def health():
            return {"status": "healthy"}
        
        @app.post("/generate")
        async def generate_video(request: VideoRequest):
            try:
                print(f"ğŸ¬ Generating: {request.prompt}")
                
                from diffusers import DiffusionPipeline
                from diffusers.utils import export_to_video
                
                pipe = DiffusionPipeline.from_pretrained('damo-vilab/text-to-video-ms-1.7b')
                pipe = pipe.to('cpu')
                
                video_frames = pipe(
                    request.prompt,
                    num_inference_steps=request.steps,
                    num_frames=request.frames,
                    height=64,
                    width=64,
                ).frames[0]
                
                filename = f"video_{int(time.time())}.mp4"
                os.makedirs("videos", exist_ok=True)
                video_path = f"videos/{filename}"
                export_to_video(video_frames, video_path)
                
                return {
                    "status": "success",
                    "download_url": f"/download/{filename}",
                    "filename": filename
                }
                
            except Exception as e:
                raise HTTPException(500, detail=str(e))
        
        @app.get("/download/{filename}")
        async def download_video(filename: str):
            video_path = f"videos/{filename}"
            if os.path.exists(video_path):
                return FileResponse(video_path, filename=filename)
            raise HTTPException(404, detail="Video not found")
        
        def start_server():
            uvicorn.run(app, host="0.0.0.0", port=8000)
        
        if __name__ == "__main__":
            os.makedirs("videos", exist_ok=True)
            
            # Start Serveo tunnel (no password required)
            print("ğŸš€ Starting Serveo tunnel...")
            serveo_process = subprocess.Popen(
                ["ssh", "-o", "StrictHostKeyChecking=no", "-R", "80:localhost:8000", "serveo.net"],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True
            )
            
            # Wait for Serveo URL
            time.sleep(10)
            
            # Try to get URL from Serveo output
            try:
                for line in serveo_process.stderr:
                    if "serveo.net" in line:
                        print(f"ğŸŒ Serveo URL: https://{line.split()[-1]}")
                        break
            except:
                pass
            
            # Start server
            server_thread = threading.Thread(target=start_server)
            server_thread.daemon = True
            server_thread.start()
            
            print("âœ… Server started!")
            time.sleep(60 * 25)
        EOF

    - name: Start server with Serveo
      run: |
        # Start the server (Serveo starts automatically in the script)
        python server.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        
        # Give it time to establish tunnel
        sleep 15
        echo "ğŸŒ Serveo tunnel should be active"
        echo "ğŸ’¡ Check workflow logs for the Serveo URL"

    - name: Display information
      run: |
        echo "=========================================="
        echo "ğŸ‰ VIDEO SERVER IS LIVE!"
        echo "=========================================="
        echo ""
        echo "ğŸŒ Check the workflow logs above for your Serveo URL"
        echo "ğŸ” NO PASSWORD REQUIRED!"
        echo ""
        echo "âš¡ The URL will look like: https://xxx.serveo.net"
        echo ""
        echo "â° Runs for 25 minutes"
        echo "=========================================="

    - name: Keep alive
      run: |
        sleep 1500

    - name: Cleanup
      if: always()
      run: |
        pkill -f "python server.py" || true
        pkill -f ssh || true
