# .github/workflows/video-server-no-auth.yml
name: Video Server - No Authentication Needed

on: [workflow_dispatch]

jobs:
  server:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python and Node.js
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install diffusers transformers
        pip install fastapi uvicorn
        pip install opencv-python imageio imageio-ffmpeg pillow
        
    - name: Install LocalTunnel
      run: npm install -g localtunnel
        
    - name: Create video server
      run: |
        cat > server.py << 'EOF'
        from fastapi import FastAPI, HTTPException
        from fastapi.responses import FileResponse
        from pydantic import BaseModel
        import uvicorn
        import threading
        import time
        import os
        import subprocess
        import requests
        from datetime import datetime
        
        app = FastAPI(title="Video Generator", description="No authentication needed!")
        
        class VideoRequest(BaseModel):
            prompt: str = "A teddy bear waving"
            steps: int = 10
            frames: int = 4
        
        @app.get("/")
        async def home():
            return {
                "message": "ðŸŽ¬ Video Generation Server (No Auth)", 
                "status": "running",
                "endpoints": {
                    "health": "GET /health",
                    "generate": "POST /generate",
                    "download": "GET /download/{filename}"
                }
            }
        
        @app.get("/health")
        async def health():
            return {"status": "healthy", "timestamp": datetime.now().isoformat()}
        
        @app.post("/generate")
        async def generate_video(request: VideoRequest):
            try:
                print(f"ðŸŽ¬ Generating: {request.prompt}")
                
                from diffusers import DiffusionPipeline
                from diffusers.utils import export_to_video
                
                pipe = DiffusionPipeline.from_pretrained('damo-vilab/text-to-video-ms-1.7b')
                pipe = pipe.to('cpu')
                
                video_frames = pipe(
                    request.prompt,
                    num_inference_steps=request.steps,
                    num_frames=request.frames,
                    height=64,
                    width=64,
                ).frames[0]
                
                filename = f"video_{int(time.time())}.mp4"
                os.makedirs("videos", exist_ok=True)
                video_path = f"videos/{filename}"
                export_to_video(video_frames, video_path)
                
                return {
                    "status": "success",
                    "message": "Video generated!",
                    "download_url": f"/download/{filename}",
                    "filename": filename
                }
                
            except Exception as e:
                raise HTTPException(500, detail=str(e))
        
        @app.get("/download/{filename}")
        async def download_video(filename: str):
            video_path = f"videos/{filename}"
            if os.path.exists(video_path):
                return FileResponse(video_path, filename=filename)
            raise HTTPException(404, detail="Video not found")
        
        def start_server():
            uvicorn.run(app, host="0.0.0.0", port=8000)
        
        if __name__ == "__main__":
            os.makedirs("videos", exist_ok=True)
            
            # Start server
            server_thread = threading.Thread(target=start_server)
            server_thread.daemon = True
            server_thread.start()
            
            print("âœ… FastAPI server started on port 8000")
            print("â° Waiting for LocalTunnel URL...")
            
            # Keep alive
            time.sleep(60 * 25)
        EOF

    - name: Start server and LocalTunnel
      run: |
        # Start FastAPI server
        python server.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 5
        
        # Start LocalTunnel and capture URL
        npx localtunnel --port 8000 > lt.log 2>&1 &
        echo "LT_PID=$!" >> $GITHUB_ENV
        sleep 10
        
        # Extract URL from LocalTunnel output
        LT_URL=$(grep -o 'your url is: https://[^ ]*' lt.log | cut -d' ' -f4)
        echo "PUBLIC_URL=$LT_URL" >> $GITHUB_ENV
        echo "ðŸŒ Public URL: $LT_URL"
        
        # Write URL to file for backup
        echo "$LT_URL" > public_url.txt

    - name: Display clickable link
      run: |
        echo "=========================================="
        echo "ðŸŽ‰ VIDEO SERVER IS LIVE!"
        echo "=========================================="
        echo ""
        echo "ðŸ‘‰ CLICK HERE: $PUBLIC_URL"
        echo ""
        echo "ðŸ“‹ Test with:"
        echo "   curl -X POST '$PUBLIC_URL/generate' \\"
        echo "     -H 'Content-Type: application/json' \\"
        echo "     -d '{\"prompt\": \"A teddy bear\"}'"
        echo ""
        echo "â° Runs for 25 minutes"
        echo "=========================================="
        
        # Create clickable link in summary
        echo "## ðŸŽ¬ Video Generation Server" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ [Click to Access Your Server]($PUBLIC_URL)" >> $GITHUB_STEP_SUMMARY

    - name: Keep server alive
      run: |
        echo "ðŸ•’ Server running at: $PUBLIC_URL"
        sleep 1500

    - name: Cleanup
      if: always()
      run: |
        pkill -f "python server.py" || true
        pkill -f localtunnel || true
        echo "âœ… Cleaned up"
